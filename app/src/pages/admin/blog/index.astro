---
import AdminLayout from '../../../layouts/AdminLayout.astro';
// Removed incorrect import: import { Button, Table, TableHead, TableBody, TableHeadCell, TableRow, TableCell } from 'flowbite-astro';
// We will use standard HTML elements with Flowbite classes instead.

// Fetch blog posts from the API endpoint
// Note: Fetching data directly on the server-side for the initial load.
// Client-side fetching could be used for dynamic updates (sorting, filtering, pagination).
let posts = [];
let fetchError = null;
try {
  // Use Astro.url.origin to construct the full API URL for server-side fetch
  const apiUrl = new URL('/api/admin/blog', Astro.url.origin);
  const response = await fetch(apiUrl.toString());
  if (!response.ok) {
    throw new Error(`API Error: ${response.status} ${response.statusText}`);
  }
  posts = await response.json();
} catch (error) {
  console.error('Failed to fetch blog posts:', error);
  fetchError = error.message || 'Could not load blog posts.';
}

// Helper to format date
function formatDate(dateString) {
  if (!dateString) return 'N/A';
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric', month: 'short', day: 'numeric'
  });
}
---

<AdminLayout title="Manage Blog Posts">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Manage Blog Posts</h1>
    {/* Replaced Button component with standard anchor styled as Flowbite button */}
    <a href="/admin/blog/new" class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white bg-primary-700 rounded-lg hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">
      <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
      Add New Post
    </a>
  </div>

  {fetchError && (
    <div class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400" role="alert">
      <span class="font-medium">Error!</span> {fetchError}
    </div>
  )}

  {!fetchError && posts.length === 0 && (
    <p class="text-center text-gray-500 dark:text-gray-400 py-8">No blog posts found.</p>
  )}

  {!fetchError && posts.length > 0 && (
    <div class="overflow-x-auto relative shadow-md sm:rounded-lg">
      {/* Replaced Table components with standard table + Flowbite classes */}
      <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
          <tr>
            <th scope="col" class="py-3 px-6">Title</th>
            <th scope="col" class="py-3 px-6">Category</th>
            <th scope="col" class="py-3 px-6">Published</th>
            <th scope="col" class="py-3 px-6">Last Updated</th>
            <th scope="col" class="py-3 px-6">Status</th> {/* Placeholder */}
            <th scope="col" class="py-3 px-6">
              <span class="sr-only">Actions</span>
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
          {posts.map((post) => (
            <tr class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-600" data-post-id={post._id}>
              <td class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                {post.title}
              </td>
              <td class="py-4 px-6">{post.category}</td>
              <td class="py-4 px-6">{formatDate(post.pubDate)}</td>
              <td class="py-4 px-6">{formatDate(post.updatedDate)}</td>
              <td class="py-4 px-6">{post.featured ? 'Featured' : 'Standard'}</td> {/* Example status */}
              <td class="py-4 px-6 text-right whitespace-nowrap">
                <a href={`/admin/blog/${post._id}`} class="font-medium text-primary-600 dark:text-primary-500 hover:underline mr-3">Edit</a>
                <button type="button" class="font-medium text-red-600 dark:text-red-500 hover:underline delete-button">Delete</button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  )}

  {/* TODO: Add pagination if needed */}

</AdminLayout>

<script>
  // Client-side script for delete confirmation and action
  document.addEventListener('DOMContentLoaded', () => {
    const deleteButtons = document.querySelectorAll('.delete-button');

    deleteButtons.forEach(button => {
      button.addEventListener('click', async (event) => {
        const row = (event.target as HTMLElement).closest('tr');
        const postId = row?.dataset.postId;
        const postTitle = row?.querySelector('td:first-child')?.textContent?.trim() || 'this post';

        if (!postId) {
          console.error('Could not find post ID for deletion.');
          alert('Error: Could not identify the post to delete.');
          return;
        }

        if (confirm(`Are you sure you want to delete the post "${postTitle}"? This action cannot be undone.`)) {
          try {
            // Send DELETE request to the API
            const response = await fetch(`/api/admin/blog?id=${postId}`, {
              method: 'DELETE',
            });

            const result = await response.json();

            if (response.ok) {
              alert(`Post "${postTitle}" deleted successfully.`);
              row?.remove(); // Remove the row from the table
              // Optionally, check if table is empty and show message
            } else {
              console.error('API Error:', result);
              alert(`Failed to delete post: ${result.message || 'Unknown error'}`);
            }
          } catch (error) {
            console.error('Network or script error:', error);
            alert(`An error occurred while trying to delete the post: ${error.message}`);
          }
        }
      });
    });
  });
</script>
