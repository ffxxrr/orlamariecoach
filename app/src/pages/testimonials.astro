---
// import { getCollection } from 'astro:content'; // Removed
import MainLayout from '../layouts/MainLayout.astro';
import TestimonialCard from '../components/testimonials/TestimonialCard.astro';
import { connectToDatabase } from '../utils/db/connect.js';
import Testimonial from '../utils/db/models/Testimonial.js';

let dbTestimonials = [];
try {
  await connectToDatabase();
  // Fetch all testimonials from MongoDB
  const allTestimonialsFromDb = await Testimonial.find({})
    .sort({ order: 1 }) // Sort by the order field, ascending
    .lean();

  // Adapt the structure to match what TestimonialCard expects (data property)
  dbTestimonials = allTestimonialsFromDb.map(testimonial => ({
    id: testimonial._id.toString(),
    // No slug for testimonials usually
    data: {
      clientName: testimonial.clientName,
      quote: testimonial.quote,
      rating: testimonial.rating,
      image: testimonial.image,
      order: testimonial.order,
      // Add other fields expected by TestimonialCard if necessary
    }
  }));

} catch (error) {
  console.error("Error fetching testimonials from DB:", error);
  // Handle error appropriately
}
---

<MainLayout title="Client Testimonials" description="Hear from clients who have benefited from OrlaMarie's coaching services.">
  <section class="bg-white dark:bg-gray-900 py-8 lg:py-16">
    <div class="container mx-auto px-4">
      <div class="max-w-screen-md mx-auto text-center mb-8 lg:mb-12">
        <h2 class="mb-4 text-4xl tracking-tight font-extrabold text-gray-900 dark:text-white">Client Success Stories</h2>
        <p class="font-light text-gray-500 sm:text-xl dark:text-gray-400">
          Discover how OrlaMarie's coaching has helped individuals achieve their personal and professional goals.
        </p>
      </div>

      {dbTestimonials.length > 0 ? (
        <div class="grid gap-8 lg:grid-cols-1">
          {dbTestimonials.map((testimonial) => (
            <TestimonialCard testimonial={testimonial} /> // Pass adapted object
          ))}
        </div>
      ) : (
        <p class="text-center text-gray-500 dark:text-gray-400">No testimonials available yet.</p>
      )}
    </div>
  </section>
</MainLayout>
